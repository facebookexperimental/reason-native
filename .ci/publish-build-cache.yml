steps:

  - bash: 'touch .'
    workingDirectory: '$(STAGING_DIRECTORY)'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    displayName: 'Create cache directory'

  - bash: 'tar -czf $(STAGING_DIRECTORY_UNIX)/esy-cache.tar .'
    workingDirectory: '$(ESY__CACHE_INSTALL_PATH)'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    displayName: 'Tar esy cache directory'

  - bash: 'tar -czf $(STAGING_DIRECTORY_UNIX)/npm-cache.tar .'
    workingDirectory: '$(NPM__GLOBAL_ROOT)'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    displayName: 'Tar npm cache directory'

  - task: PublishBuildArtifacts@1
    displayName: 'Cache: Upload tarball'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    inputs:
        pathToPublish: '$(STAGING_DIRECTORY)'
        artifactName: 'cache-$(Agent.OS)-install'
        parallel: true
        parallelCount: 8
